<html>

<head>
  <!-- Latest compiled and minified CSS -->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">
  <!-- jQuery library -->
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
  <!-- Latest compiled JavaScript -->
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>
  <title>Principal</title>
</head>

<script type="text/javascript">

  $(function () {

    $('#table_metricas').hide();

    function verDetalles() {
      $('#table_metricas').toggle();
      let mas_text = $('#btn_mas').text()
      if (mas_text == "Ver más detalles...") {
        $('#btn_mas').text("Ver menos detalles...");

      } else {
        $('#btn_mas').text("Ver más detalles...");
      }
    }
    function audio_response() {
        var res = $("#prediction").text();
        if (res == "Verdad") {
          rnd = Math.floor(Math.random() * 3);
          console.log(rnd);
          let audio_verdad;
          if(rnd == 0){
            audio_verdad = new Audio("{{ url_for('static', filename='audio/verdura.mp3') }}");
          }else{
            audio_verdad = new Audio("{{ url_for('static', filename='audio/verdad.mp3') }}");
          }
          
          audio_verdad.play();
        } else if (res == "Mentira") {
          let audio_mentira = new Audio("{{ url_for('static', filename='audio/mentira.mp3') }}");
          audio_mentira.play();
        }
    }

    $("#btn_mas").on("click", function(){
      verDetalles();
    });

    $('button#on').bind('click', function () {
      $(this).toggleClass('btn-primary btn-info');
      var text = $('button#on').text();
      if (text === "Iniciar") {
        $("#on").html('Esperar');
        var counter = 3;
        id = document.getElementById("count_num");
        id.innerHTML = counter;

        setInterval(function () {
          counter--;
          if (counter >= 0) {
            id.innerHTML = counter;
          }
          if (counter === 0) {
            id.innerHTML = "La grabación se ha iniciado";
            //AQUI SE EMPIEZA A GRABAR
            console.log("Entra");
            $("#on").html('Detener');
            $.getJSON('/startRecording',
              function (data) {
                //do nothing
              });
          }
        }, 1000);

        /*
        $(this).html('Detener');
        $.getJSON('/startRecording',
          function(data) {
        //do nothing
      });
      */

      } else if (text === "Detener") {
        $(this).text('Iniciar');
        $('div#loading').css("visibility", "visible");
        $('#cargando').html("Cargando");
        $.getJSON('/stopRecording',
          function (data) {
            $('div#loading').hide();
            $('#cargando').hide();
            $("#count_num").text("");
            $("#prediction").text(data["prediccion"]);
            $("#metric_1").text(data["metrica_1"]);
            $("#metric_2").text(data["metrica_2"]);
            $("#mdl_details").modal("show");
            audio_response();
            //window.location.replace("http://localhost:5001/details")
            //go to details view
          });
      }
      $('button#on2').html('To Try');
      return false;
    });
  });
</script>

<style>
  .loader {
    border: 4px solid #f3f3f3;
    /* Light grey */
    border-top: 4px solid #3498db;
    /* Blue */
    border-radius: 50%;
    width: 30px;
    height: 30px;
    animation: spin 2s linear infinite;
    visibility: hidden;
    margin: 0 auto;
  }

  @keyframes spin {
    0% {
      transform: rotate(0deg);
    }

    100% {
      transform: rotate(360deg);
    }
  }
</style>

<body onmouseup="mouseUp()" style="background-image: url({{ url_for('static', filename='images/bg.jpg') }})">

  <!-- Instruction button modal -->
  <button id="btnInstruction" onmousedown="mouseDown()" type="button" class="btn btn-sm pull-right btn-primary"
    data-toggle="modal" data-target="#modalInstrucciones" style="z-index: 99999;">
    Abrir instrucciones...
  </button>

  <!-- Camera -->
  <div class="text-center">
    <div class="container">
      <h1 style="color:white">IA de la Verdad</h1>
      <h4 style="color:white">Posicione su rostro dentro del rango de la cámara</h4>
      <img height="50%" id="bg" src="{{ url_for('video_feed') }}">

      <h2 style="color:white" id="count_num"></h2>

      <div class="row my-2">
        <button type="button" class="btn btn-primary mx-auto" id=on>Iniciar</button>
      </div>
      <h4 id="res" style="color:white"></h4>
      <div class="loader" id=loading>
      </div>
      <h5 id="cargando" style="color:white"></h5>
    </div>
  </div>

  <!-- Modal -->
  <div class="modal fade" id="modalInstrucciones" tabindex="-1" role="dialog"
    aria-labelledby="instruccionesModalLongTitle" aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h3 class="modal-title" id="instruccionesModalLongTitle">Instrucciones</h3>
        </div>
        <div class="modal-body">
          <h6>1. El usuario debe encontrarse a una distancia de entre 50cm a 150cm.</h6>
          <h6>2. El usuario no debería utilizar ningún accesorio que cubra su rostro (lentes, bandanas, máscaras).</h6>
          <h6>3. El usuario debe minimizar el movimiento de su cabeza.</h6>
          <h6>4. Si en algún momento, no se logra capturar correctamente el rostro, el indicador de abajo indicara si
            funciona o no.</h6>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="mdl_details" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
      <div class="modal-content">
        <div class="modal-body">
          <h1 id="prediction" class="text-center" style="font-size: 48px; font-weight:bold;"></h1>
          <div class="text-center">
            <a id="btn_mas" style="cursor: pointer;">Ver más detalles...</a>

          </div>
            <table id="table_metricas" class="table table-responsive table-bordered text-center">
              <thead>
                <tr>
                  <th class="text-center" colspan="2" >Métricas</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td >Métrica 1</td>
                  <td id="metric_1" ></td>
                </tr>
                <tr>
                  <td >Métrica 2</td>
                  <td id="metric_2" ></td>
              </tbody>
            </table>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-default btn-primary" data-dismiss="modal">Intentar de Nuevo</button>
          <button type="button" class="btn btn-default btn-primary" onclick="document.location='/'" >Salir</button>
        </div>
      </div><!-- /.modal-content -->
    </div><!-- /.modal-dialog -->
  </div><!-- /.modal -->

  <script type="text/javascript" src="{{ url_for('static', filename = 'js/face_available.js') }}"></script>
  <script type="text/javascript" src="{{ url_for('static', filename = 'js/press_instructions.js') }}"></script>>
  <script type="text/javascript" src="{{ url_for('static', filename = 'js/start_function.js') }}"></script>
  </script>
</body>

</html>